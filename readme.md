# Edax find book error tool


## 概要
このプログラムは、Edaxbookを解析し、各modeに応じたbookのポジションごとの不一致などのエラーを検出するツールです


## 主な機能
- Edax形式のオセロブックの読み込み（Egaroucid形式は対応していません) 
- 各mode設定に応じて不一致などのエラーのある局面の検出と出力(子ポジションまでの棋譜一覧が出力されます)
- デバッグログの生成


## 使用方法
1. `book.dat`（Edax形式のブックファイル）を実行ファイルと同じディレクトリに配置します。bookファイルそのものは各自ご用意ください。
2. プログラムを実行します。
3. 結果は`mismatched_positions.txt`ファイルに出力されます。そのままedax runnnerによって学習が可能です。設定したデバッグログレベルに応じて`debuglog.txt`も出力されます。



## 設定
`config.ini`ファイルで以下の設定を行うことができます：

1. デバッグログレベル（log_level）：
   - 利用可能なオプション: DEBUG, INFO, WARNING, ERROR, NONE
   - この設定により、出力されるログの詳細度が変わります。

2. ログレベル自動調整機能（auto_adjust_level）：
   - true または False で設定（大文字小文字は区別されません）
   - True の場合、WARNING以上が出力されたときにログレベルが自動的に調整後のレベルに下がります。元の設定がERRORの場合はERRORが出力されるとレベルが変わります。

3. 調整後のログレベル（adjusted_level）：
   - 利用可能なオプション: DEBUG, INFO, WARNING, ERROR, NONE
   - auto_adjust_level が True の場合に適用されるログレベルです。ここで設定したレベルに下がります。逆に元より上げることはできません。

これらの設定により、デバッグログの出力量と内容をカスタマイズできます。

4. mode 1 2 3 4 5
mode 1 2 3 4 は判定方法の違いです。1と、234が大きな差です。5は特殊モードでプログラムが動きます。
これから先、あるポジションを親ポジションとし、子ポジションを親ポジションから1手打って到達できるポジションとします。

mode 1
子ポジションのリーフの手の評価値と、子ポジションのリンクの手のうち最大の評価値を持つものの評価値を比較　
leafeval>linkmaxeval の場合、子ポジションのリーフの手までの棋譜を出力します。

mode 2
子ポジションの評価値と子ポジションのリンクやリーフの評価値のうち最大のものの評価を比較
リンクやリーフが大きい場合は子ポジションの評価値より大きい評価値を持つ全ての子ポジションのリンクやリーフの棋譜を出力します。
小さい場合はその判定に使った子ポジションの手までの棋譜を出力します。

mode 3
親ポジションの(子ポジションに到達するために打った）リンクもしくはリーフの評価値と、子ポジションの評価値の反転を比較
子ポジションの評価値のほうが大きい場合は親ポジションの(子ポジションに到達するために打った）リンクもしくはリーフの評価値に－1をかけたものより大きい評価値を持つ全ての子ポジションのリンクやリーフの棋譜を出力します。
小さい場合はその判定に使った子ポジションの手までの棋譜を出力します。

mode 4
親ポジションの(子ポジションに到達するために打った）リンクもしくはリーフの評価値と、子ポジションのリンクやリーフの評価値のうち最大のものの評価値の反転を比較
子ポジションのリンクやリーフの評価値のほうが大きい場合は親ポジションの(子ポジションに到達するために打った）リンクもしくはリーフの評価値に－1をかけたものより大きい評価値を持つ全ての子ポジションのリンクやリーフの棋譜を出力します。
小さい場合はその判定に使った子ポジションの手までの棋譜を出力します。

mode 5
プログラムがspecified_positions_modeで起動します。
specified_positions.txtに記載されている盤面データ一覧ををbookから読み込んで順番にdebug.logに出力します。
プログラムはその時点で終了します。デバッグ出力レベルがNONEだとなにも出力されないので注意です。



## ソースコード
Edaxbook findmismatcherror_source.cppのファイルがソースコードです　C++で書かれています。
ソースコードのビルドにはC++17以上が必要です。


## 謝辞
ソフト開発にあたり、ツールの利用や、助言などをいただきました。ここに謝辞を表明します。
山名琢翔　様
きしまろ　様
kroud     様
このプログラムのコードはClaude 3.5 Sonetを利用して書かれています。

## バージョン情報
0.5 β

## 更新履歴
0.5 β
各modeについて完走確認がとれたためβ版に格上げ
通常版ではifstreamをやめて読み込み速度がおよそ6倍に上昇
その他構造体を見直してパディングの無駄を減らしてわずかにメモリ効率も上昇

boost版はさらなる圧倒的な進化
boost unorderd_mapにより各種速度がかなり早くなり（メモリ効率はあまり変わらないがハッシュ衝突率が24.4％まで減少)
boost small vectorによりメモリ効率が大幅に上昇
読み込み速度は無印版と比べて1.75倍、メモリ効率は1.12倍上昇（5GBのbookを扱うとだいたい1.5GBのメモリ節約になる)速度も1.1～1.2倍くらい違うはず
これ以上メモリ効率をよくするにはメモリアロケータなどの自前実装などが必要になりそうでかなり難易度が高い
巨大bookを扱う場合はboost版を推奨。そうでない場合はどちらでもいいが、ビルドするなら無印版はボタン一発で簡単にビルドできる。

その他boost版のみハッシュ関数を変更するとごくわずかに衝突が減ってハッシュ計算時間が半分近くになることがあったのでそれを採用。

0.41 α
判定条件に合ったバグ(変数の初期化の誤り)を修正
これでついにmode1で出力が得られるようになった。虚無からの解放
mode2～4は調査中

0.4 α
判定方法の違いによる各modeを実装 
5だけspetfic modeになる(0.31αで実装したもの)
その他関数名の変更等内部の変更

0.31 α
特定のポジションをbookから読み込んでプログラムを終了するモードの搭載
問題がありそうな特定のポジションを調べるための機能


0.3 α
判定条件を修正　子ポジションのeval値ではなく、
子ポジションのlinkやleafのうち最大のものの符号反転が親ポジションから子ポジションに到達するための手のlinkやleafの評価値と一致するかどうかに判定を変更
1ループごとではなくプログラム全体の実行時間を判定するように修正
boostを入れてメモリマップドファイルを使用してbook読み込みが爆速になるバージョンを用意。boostはビルドが難しいのでどうしようか考え中。

0.27 α
book読み込み前にreserveするようにした
バッファも設定した(128MB)
unorderd mapが返ってこないようにグローバル関数へ移動
ファイル読み込み速度をデバッグログに出力

0.25 α
コマンドラインに進捗状況を10万リンクorリーフごとに表示する機能を搭載
デバッグ出力レベルが間違っていたので修正。ERRORレベル設定で何かしらの原因でプログラムが終了したらデバッグログを出力するように(正常終了でも）

0.2 α
move値がパスやnoneの値を取るときの挙動を正しく設定。これで（バグがなければ)正しく動くはず　
0.1αがこの設定が間違っていてメモリアクセス違反を起こしていた。危険。これは解消。
初期盤面をコード内に記載するのではなくbookから読み込むように修正、その影響でポジションマネージャーの関数を一つ削除　初手がE6から始まるように
潜在的なバグ解消(初手の評価値が0じゃないbook対策)
内部構造を見直し、余計なbool二つを排除　メモリ効率が向上　余計な関数も一つ削除
コード内にコメント行を配置し、どこが何をやっているか分かりやすくなりました

0.1 α
ライセンスなどを固めて公開

## ライセンス
このプロジェクトはMITライセンスの下で公開されています。

(c) [2024] [わんりゅー]

詳細は以下のURLをご覧ください：
https://licenses.opensource.jp/MIT/MIT.html